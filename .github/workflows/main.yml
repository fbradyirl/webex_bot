name: Python package

on:
    push:
        branches: [ main ]
        tags:
            - "v*"
    pull_request:

jobs:
    build:
        runs-on: ubuntu-latest
        strategy:
            max-parallel: 5
            matrix:
                python-version: [ "3.10", "3.11", "3.12" ]

        steps:
            -   uses: actions/checkout@v4
            -   name: Set up Python ${{ matrix.python-version }}
                uses: actions/setup-python@v5
                with:
                    python-version: ${{ matrix.python-version }}
                    cache: pip
                    cache-dependency-path: |
                        requirements_dev.txt
                        setup.cfg
                        setup.py
            -   name: Install dependencies
                run: |
                    python -m pip install --upgrade pip
                    pip install tox tox-gh-actions "setuptools<70" wheel
            -   name: Test with tox
                run: tox
            -   name: Upload coverage artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: coverage-${{ matrix.python-version }}
                    path: |
                        coverage.xml
                        htmlcov
            -   name: Upload coverage to Codecov
                uses: codecov/codecov-action@v4
                with:
                    files: coverage.xml
                    flags: ${{ matrix.python-version }}
                    fail_ci_if_error: false
                env:
                    CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
            -   name: Build distributions
                if: matrix.python-version == '3.12'
                run: |
                    rm -rf dist/
                    pip install "setuptools<70" wheel
                    python setup.py sdist bdist_wheel --universal
            -   name: Verify wheel metadata
                if: matrix.python-version == '3.12'
                run: |
                    pip install twine
                    twine check dist/*
            -   name: Upload release to pypi
                if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags') && matrix.python-version == '3.12'
                uses: pypa/gh-action-pypi-publish@v1.4.1
                with:
                    password: ${{ secrets.pypi_password }}
